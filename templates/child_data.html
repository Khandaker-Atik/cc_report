{% extends "base.html" %}

{% block title %}Child Growth Data - Community Clinic Data Management{% endblock %}

{% block extra_head %}
<style>
    .vaccine-badge {
        transition: all 0.3s ease;
    }
    .vaccine-badge:hover {
        transform: translateY(-2px) scale(1.05);
    }
    .growth-metric {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        border-left: 4px solid;
    }
    .growth-metric.height { border-color: #3b82f6; }
    .growth-metric.weight { border-color: #10b981; }
    .growth-metric.age { border-color: #8b5cf6; }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="mb-8">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-4xl font-bold text-gray-800 mb-2 flex items-center">
                <i class="fas fa-baby text-purple-600 mr-4"></i>
                Child Growth Data
            </h1>
            <p class="text-gray-600 text-lg">Track child development with growth metrics and vaccination schedules</p>
        </div>
        <div class="hidden md:flex items-center space-x-4">
            <div class="text-right">
                <div class="text-sm text-gray-500 uppercase tracking-wide">Healthcare</div>
                <div class="text-lg font-semibold text-gray-800">Child Development</div>
            </div>
            <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                <i class="fas fa-chart-line text-purple-600"></i>
            </div>
        </div>
    </div>
</div>

<div class="grid lg:grid-cols-3 gap-8">
    <!-- Input Form -->
    <div class="lg:col-span-1">
        <div class="pro-form">
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Child Information</h2>
                <p class="text-gray-600">Enter child details to get growth standards and vaccine info</p>
            </div>
            
            <form method="POST" class="space-y-6">
                <div class="form-group">
                    <label for="gender" class="form-label">
                        <i class="fas fa-venus-mars mr-2"></i>
                        Child Gender
                    </label>
                    <select id="gender" name="gender" required class="form-control form-select">
                        <option value="" disabled selected>Select child's gender</option>
                        <option value="male" {% if request.form.gender == 'male' %}selected{% endif %}>
                            ðŸ‘¦ Boy
                        </option>
                        <option value="female" {% if request.form.gender == 'female' %}selected{% endif %}>
                            ðŸ‘§ Girl
                        </option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="age" class="form-label">
                        <i class="fas fa-calendar-alt mr-2"></i>
                        Age in Months
                    </label>
                    <input type="number" step="0.01" min="0" max="60" id="age" name="age" 
                           class="form-control" placeholder="e.g., 3.25 for 3 months 8 days"
                           value="{{ request.form.age if request.form.age }}" required>
                    <div class="mt-2 text-sm text-gray-500">
                        <i class="fas fa-info-circle mr-1"></i>
                        Enter decimal values for precise age (e.g., 3.25 = 3 months 8 days)
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary w-full">
                    <i class="fas fa-search mr-2"></i>
                    Get Growth Standards
                </button>
            </form>
            
            <!-- Age Guide -->
            <div class="mt-8 p-4 bg-purple-50 rounded-lg border border-purple-200">
                <h3 class="font-semibold text-purple-800 mb-3">
                    <i class="fas fa-lightbulb mr-2"></i>
                    Age Calculation Guide
                </h3>
                <div class="text-sm text-purple-700 space-y-2">
                    <div class="flex justify-between">
                        <span>1 month</span>
                        <span class="font-mono">1.00</span>
                    </div>
                    <div class="flex justify-between">
                        <span>1 month 15 days</span>
                        <span class="font-mono">1.50</span>
                    </div>
                    <div class="flex justify-between">
                        <span>3 months 8 days</span>
                        <span class="font-mono">3.25</span>
                    </div>
                    <div class="flex justify-between">
                        <span>6 months 10 days</span>
                        <span class="font-mono">6.33</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div class="lg:col-span-2">
        {% if error_message %}
        <div class="pro-card p-6 border-l-4 border-red-500 bg-red-50">
            <div class="flex items-center">
                <i class="fas fa-exclamation-triangle text-red-500 text-xl mr-3"></i>
                <div>
                    <h3 class="text-lg font-semibold text-red-800">Error</h3>
                    <p class="text-red-700">{{ error_message }}</p>
                </div>
            </div>
        </div>
        {% elif result %}
        <div class="space-y-6">
            <!-- Child Info Summary -->
            <div class="result-card">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                        <i class="fas fa-{{ 'male' if request.form.gender == 'male' else 'female' }} text-{{ 'blue' if request.form.gender == 'male' else 'pink' }}-600 mr-3"></i>
                        {{ 'Boy' if request.form.gender == 'male' else 'Girl' }} Development Standards
                    </h2>
                    <span class="px-4 py-2 bg-purple-100 text-purple-800 rounded-full text-sm font-semibold">
                        {{ result.age_string }}
                    </span>
                </div>
                
                <!-- Growth Metrics -->
                <div class="grid md:grid-cols-3 gap-6 mb-8">
                    <div class="growth-metric age p-6 rounded-xl">
                        <div class="flex items-center justify-between mb-2">
                            <i class="fas fa-birthday-cake text-purple-600 text-2xl"></i>
                            <span class="text-xs uppercase tracking-wide text-gray-500 font-semibold">Age</span>
                        </div>
                        <div class="text-2xl font-bold text-gray-800">{{ result.age_string }}</div>
                        <div class="text-sm text-gray-600">Current Age</div>
                    </div>
                    
                    <div class="growth-metric height p-6 rounded-xl">
                        <div class="flex items-center justify-between mb-2">
                            <i class="fas fa-ruler-vertical text-blue-600 text-2xl"></i>
                            <span class="text-xs uppercase tracking-wide text-gray-500 font-semibold">Height</span>
                        </div>
                        <div class="text-2xl font-bold text-gray-800">{{ result.standard_height }} cm</div>
                        <div class="text-sm text-gray-600">Standard Height</div>
                    </div>
                    
                    <div class="growth-metric weight p-6 rounded-xl">
                        <div class="flex items-center justify-between mb-2">
                            <i class="fas fa-weight text-green-600 text-2xl"></i>
                            <span class="text-xs uppercase tracking-wide text-gray-500 font-semibold">Weight</span>
                        </div>
                        <div class="text-2xl font-bold text-gray-800">{{ result.standard_weight }} kg</div>
                        <div class="text-sm text-gray-600">Standard Weight</div>
                    </div>
                </div>

                <!-- BMI Calculation -->
                <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <i class="fas fa-calculator text-gray-600 mr-2"></i>
                            <span class="font-semibold text-gray-700">Standard BMI</span>
                        </div>
                        <span class="text-lg font-bold text-gray-800">
                            {{ "%.1f"|format((result.standard_weight / ((result.standard_height/100) ** 2))) }}
                        </span>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">
                        BMI = Weight (kg) Ã· HeightÂ² (mÂ²)
                    </div>
                </div>
            </div>

            <!-- Vaccination Schedule -->
            <div class="result-card">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center">
                        <i class="fas fa-syringe text-green-600 mr-3"></i>
                        Vaccination Status
                    </h3>
                    <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-semibold">
                        {{ result.vaccines|length }} Completed
                    </span>
                </div>
                
                {% if result.vaccines %}
                <div class="grid gap-3">
                    {% for vaccine in result.vaccines %}
                    <div class="vaccine-badge flex items-center justify-between p-4 bg-green-50 border border-green-200 rounded-lg">
                        <div class="flex items-center">
                            <i class="fas fa-check-circle text-green-600 mr-3"></i>
                            <span class="font-semibold text-green-800">{{ vaccine }}</span>
                        </div>
                        <span class="px-2 py-1 bg-green-200 text-green-800 rounded text-xs font-semibold">
                            âœ“ Done
                        </span>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-8">
                    <i class="fas fa-calendar-check text-gray-400 text-4xl mb-4"></i>
                    <p class="text-gray-600">No vaccines completed yet for this age</p>
                </div>
                {% endif %}
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-wrap gap-4">
                <button onclick="printResults()" class="btn btn-info">
                    <i class="fas fa-print mr-2"></i>
                    Print Report
                </button>
                <button onclick="exportData()" class="btn btn-success">
                    <i class="fas fa-download mr-2"></i>
                    Export Data
                </button>
                <button onclick="showGrowthChart()" class="btn btn-warning">
                    <i class="fas fa-chart-line mr-2"></i>
                    View Growth Chart
                </button>
            </div>
        </div>
        {% else %}
        <!-- Empty State -->
        <div class="pro-card p-12 text-center">
            <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-baby text-gray-400 text-3xl"></i>
            </div>
            <h3 class="text-xl font-semibold text-gray-800 mb-2">Ready to Check Growth</h3>
            <p class="text-gray-600 max-w-md mx-auto mb-8">
                Enter the child's gender and age to get standard growth metrics, vaccination schedule, and development tracking information.
            </p>
            
            <!-- Development Milestones -->
            <div class="bg-gray-50 rounded-lg p-6 max-w-2xl mx-auto">
                <h4 class="font-semibold text-gray-800 mb-4">Key Development Milestones</h4>
                <div class="grid md:grid-cols-2 gap-4 text-sm text-gray-600">
                    <div class="text-left">
                        <div class="font-semibold text-gray-700">Month 1-3:</div>
                        <div>â€¢ BCG vaccination</div>
                        <div>â€¢ Basic growth tracking</div>
                        <div>â€¢ Weight gain monitoring</div>
                    </div>
                    <div class="text-left">
                        <div class="font-semibold text-gray-700">Month 9-12:</div>
                        <div>â€¢ Measles vaccination</div>
                        <div>â€¢ Advanced development</div>
                        <div>â€¢ Height milestone check</div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Growth Chart Modal -->
<div id="chartModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-auto">
        <div class="p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800">Child Growth Chart</h3>
                <button onclick="closeChart()" class="text-gray-500 hover:text-gray-700 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="chart-container">
                <canvas id="growthChart" width="800" height="400"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let growthChart = null;

    function printResults() {
        window.print();
    }

    function exportData() {
        {% if result %}
        const data = {
            childInfo: {
                gender: "{{ request.form.gender }}",
                ageString: "{{ result.age_string }}",
                standardHeight: {{ result.standard_height }},
                standardWeight: {{ result.standard_weight }},
                bmi: {{ "%.1f"|format((result.standard_weight / ((result.standard_height/100) ** 2))) }}
            },
            vaccines: {{ result.vaccines|tojson }},
            generatedAt: new Date().toISOString()
        };
        
        const dataStr = JSON.stringify(data, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `child_growth_data_${Date.now()}.json`;
        link.click();
        URL.revokeObjectURL(url);
        
        showNotification('Child data exported successfully!', 'success');
        {% endif %}
    }

    function showGrowthChart() {
        document.getElementById('chartModal').classList.remove('hidden');
        
        if (!growthChart) {
            createGrowthChart();
        }
    }

    function closeChart() {
        document.getElementById('chartModal').classList.add('hidden');
    }

    function createGrowthChart() {
        const ctx = document.getElementById('growthChart').getContext('2d');
        
        // Sample growth data for demonstration
        const maleHeights = {{ male_heights|tojson if male_heights else '[]' }};
        const femaleHeights = {{ female_heights|tojson if female_heights else '[]' }};
        const maleWeights = {{ male_weights|tojson if male_weights else '[]' }};
        const femaleWeights = {{ female_weights|tojson if female_weights else '[]' }};
        const labels = {{ labels|tojson if labels else '[]' }};
        
        growthChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Male Height (cm)',
                    data: maleHeights,
                    borderColor: 'rgba(59, 130, 246, 1)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4,
                    borderWidth: 3
                }, {
                    label: 'Female Height (cm)',
                    data: femaleHeights,
                    borderColor: 'rgba(236, 72, 153, 1)',
                    backgroundColor: 'rgba(236, 72, 153, 0.1)',
                    tension: 0.4,
                    borderWidth: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Height (cm)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Age (Months)'
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                animation: {
                    duration: 2000,
                    easing: 'easeInOutQuart'
                }
            }
        });
    }

    // Close modal when clicking outside
    document.getElementById('chartModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeChart();
        }
    });
</script>
{% endblock %}
